<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Continuing Adaptation to South Beach's Shifting Shore</title>
    <link rel="icon" href="img/uw-logo-trans-150x150.png" sizes="192x192" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
    <script src="https://unpkg.com/scrollama"></script>
    <script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
    <script src="https://d3js.org/d3.v6.min.js"></script>

    

    <style>
      #loader {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        bottom: 0;
        z-index: 999;
        background: url('img/loading.gif') 50% 50% no-repeat white;
        opacity: 1;
        }

      /* #map-container {
        position: sticky;
        top: 0;
        right: 0;
        width: 67vh;
        height: 100vh;
      } */

      #map {
        position: sticky;
        position: -webkit-sticky;
        /* position: fixed; */
        top: 0;
        bottom: 0;
        /* right: 0; */
        width: 100vw;
        height: 100vh;
      }

      #geonarrative-container {
        position: relative;
        /* overflow-y: scroll; */

      }

      #story {
        /* position: relative; */
        /* position: sticky; */
        /* position: absolute; */
        z-index: 2;
        overflow-y: auto;
        height: auto;
        top: 0;
        left: 0;
        width: 35vw;
        transform: translateY(-20vh);
        }

      body {
        margin:0;
        padding:0;
        font-family: sans-serif;
        box-sizing: border-box;
        }

        a, a:hover, a:visited {
            color: #0071bc;
        }

        #header {
            margin: auto;
            width: 100%;
            position: relative;
            z-index: 5;
        }
        #header h1, #header h2, #header p {
            margin: 0;
            padding: 2vh 2vw;
            text-align: center;
        }
        #footer {
            width: 100%;
            min-height: 5vh;
            padding-top: 2vh;
            padding-bottom: 2vh;
            text-align: center;
            line-height: 25px;
            font-size: 13px;
            position: relative;
            z-index: 5;
        }
        #features {
            padding-top: 10vh;
            padding-bottom: 10vh;
        }
        .hidden {
            visibility: hidden;
        }
        .centered {
            width: 50vw;
            margin: 0 auto;
        }
        .lefty {
            width: 33vw;
            margin-left: 0vw;
        }
        .righty {
            width: 33vw;
            margin-left: 62vw;
        }
        .fully {
            width: 100%;
            margin: auto;
        }
        .light {
            color: #444;
            background-color: #fafafa;
        }
        .dark {
            color: #fafafa;
            background-color: #444;
        }
        .step {
            padding-top: 5vh;
            padding-bottom: 50vh;
            /* margin-bottom: 10vh; */
            opacity: 0.25;
            background-color: white;
        }
        .step.active {
            opacity: 0.9;
        }

        .step div {
            padding:  25px 50px;
            line-height: 25px;
            font-size: 13px;
        }

        .step img {
            width: 100%;
        }

        @media (max-width: 750px) {
            .centered, .lefty, .righty, .fully {
                width: 90vw;
                margin: 0 auto;
            }
        }

        /* Fix issue on mobile browser where scroll breaks  */
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan, 
        .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
            touch-action: unset;
        }

      
    </style>
  </head>


  <body>
    
    <div id="loader"></div>

    <nav class="navbar fixed-top navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="./">
                <img src="img/nsf_logo.png" alt="Logo" width="30" height="30" class="d-inline-block align-text-top">
                Frontpage
            </a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
              
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Chapters
                </a>
                <ul class="dropdown-menu">
                  <li><a class="dropdown-item" href="#shore-change">Historical Shoreline Movements</a></li>
                  <li><a class="dropdown-item" href="#indego">Another action</a></li>
                  <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  External Links
                </a>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" target="_blank" href="https://digitalcollections.lib.washington.edu/digital/collection/ohc/search/searchterm/coastal%20hazards/field/all/mode/exact/conn/and"> Interview Transcripts </a></li>
                    <li><a class="dropdown-item" target="_blank" href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=1940024"> M9 Project NSF Award Page</a></li>
                    <li><a class="dropdown-item" target="_blank" href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=1940024"> CoPe Project NSF Award Page</a></li>
                    <li><a class="dropdown-item" target="_blank" href="https://www.lib.washington.edu">UW Library</a></li>
                    <li><a class="dropdown-item" target="_blank" href="https://hazards.uw.edu/geology/m9/">M9 Project at UW</a></li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>

    <section id="cover"> 
        <!-- citation -->
        <li style="background: url('img/bk1.jpg') no-repeat center center;  background-size: cover;">
            <div class="lp_image_attribution">Image Attribution: <a style="color: white" target="_blank" href="https://www.usgs.gov/media/images/otter-rock-oregon">Janet Watt, USGS</a></div>
        </li>
        <li style="background: url('img/mask.png') no-repeat center center;  background-size: cover;">
            <div class="lp_image_attribution">Image Attribution: <a style="color: white" target="_blank" href="https://www.researchgate.net/publication/252069651_Dating_the_1700_Cascadia_Earthquake_Great_Coastal_Earthquakes_in_Native_Stories">Figure 3. Swaiâ€™xwe mask from mainland British Columbia from Ludwin,
                    Ruth S et al., 2005.</a>
            </div>
        </li>
        <li style="background: url('img/bk5.jpg') no-repeat center center;  background-size: cover;">
            <div class="lp_image_attribution">Image Attribution: <a style="color: white" target="_blank" href="https://www.usgs.gov/media/images/cascadia-subduction-zone-0">USGS</a></div>
        </li>

        <div class="down-arrow-cover animate__animated animate__flash animate__infinite animate__slow">
            <div class="down-arrow-cover-text">
                Click down arrow to view the stories
            </div>
            <div class="down-arrow-cover-arrow">
                <i class="bi bi-chevron-double-down animate__animated animate__flash animate__infinite animate__slow" style="font-size: 3em; color:white;text-shadow: 2px 2px 4px rgb(51, 51, 51); position: static;left: auto;transform: none ;bottom: auto;" onclick="scrollToMapbox()"></i>
            </div>
        </div>

        <div id="introText">
            <h1 class="text-center">The Continuing Adaptation to South Beach's Shifting Shore</h1>
            <!-- <h5 class="text-center"><i>this line is a place holder for subtitle</i></h5> -->
            <p style="text-align:justify">The South Beach area of Grays Harbor County, Washington,
                is a dynamic coastal environment that has been shaped by the forces of nature and
                the actions of humans. The area has been home to the Quinault Indian Nation for 
                thousands of years. The Quinault people have adapted to the changing
                landscape and have developed a deep understanding of the natural processes that shape
                the area. <br> <br> White settlers arrived in this area in the 1800s. Even though they
                have experienced significant changes in coastal environment since then as well, their presence 
                on this land is still transient and there is much to learn from the Quinault people about the history of the area and how to adapt. <br> <br>
                This Geo-narrative narrates the evolution of South Beach coastal environment. As we lay out
                scenarios of shifting shores in this storytelling, we hope to inspire you to think about how both you and your community as a whole can adapt and thrive in the face of an uncertain and challenging future.
            </p>
            <div class="footnote text-right">
                <span>This project was funded by National Science Foundation award #190024</span>
                <a target="_blank" href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=1940024"> <img src="img/nsf_logo.png" width="40px" style="vertical-align: middle;" /></a>
                <a target="_blank" href="https://www.uw.edu"> <img src="img/uw_logo.png" width="40px" style="vertical-align: middle;  margin-top: 6px;" /></a>

            </div>
        </div>
    </section>
    
    <section id="geonarrative-container">

            <div id="map"></div>

        <div id="story"></div>
        
        
    </section>
   

    <script src="./config.js"></script>

    
    <script>
        window.onload = function() {
            document.getElementById("loader").style.display = "none";
        };
    </script>

<script>
    var layerTypes = {
        'fill': ['fill-opacity'],
        'line': ['line-opacity'],
        'circle': ['circle-opacity', 'circle-stroke-opacity'],
        'symbol': ['icon-opacity', 'text-opacity'],
        'raster': ['raster-opacity'],
        'fill-extrusion': ['fill-extrusion-opacity'],
        'heatmap': ['heatmap-opacity']
    }
    
    var alignments = {
        'left': 'lefty',
        'center': 'centered',
        'right': 'righty',
        'full': 'fully'
    }

    //enumerate the years from 1700 to 1911
    let all_years_hist_shore = [];
        for (let i=1700; i<2016; i++) {
            
            all_years_hist_shore.push(i);
            
        };
    
    function getLayerPaintType(layer) {
        var layerType = map.getLayer(layer).type;
        return layerTypes[layerType];
    }
    
    function setLayerOpacity(layer) {
        var paintProps = getLayerPaintType(layer.layer);
        paintProps.forEach(function(prop) {
            var options = {};
            if (layer.duration) {
                var transitionProp = prop + "-transition";
                options = { "duration": layer.duration };
                map.setPaintProperty(layer.layer, transitionProp, options);
            }
            map.setPaintProperty(layer.layer, prop, layer.opacity, options);
        });
    }

    // function to set all layers to invisible
    function setAllHistLayersInvisible() {
        for (let i=1700; i<2015; i++) {
            map.setLayoutProperty("main-line"+i, 'visibility', 'none');
            map.setLayoutProperty("blur-line"+i, 'visibility', 'none');
            map.setLayoutProperty("blur-line-2"+i, 'visibility', 'none');
            map.setLayoutProperty("blur-line-3"+i, 'visibility', 'none');
        }
    }
    
    var story = document.getElementById('story');
    var features = document.createElement('div');
    features.setAttribute('id', 'features');
    
    var header = document.createElement('div');
    
    if (config.title) {
        var titleText = document.createElement('h1');
        titleText.innerText = config.title;
        header.appendChild(titleText);
    }
    
    if (config.subtitle) {
        var subtitleText = document.createElement('h2');
        subtitleText.innerText = config.subtitle;
        header.appendChild(subtitleText);
    }
    
    if (config.byline) {
        var bylineText = document.createElement('p');
        bylineText.innerText = config.byline;
        header.appendChild(bylineText);
    }
    
    if (header.innerText.length > 0) {
        header.classList.add(config.theme);
        header.setAttribute('id', 'header');
        story.appendChild(header);
    }
    
    config.chapters.forEach((record, idx) => {
        var container = document.createElement('div');
        var chapter = document.createElement('div');
    
        if (record.title) {
            var title = document.createElement('h3');
            title.innerText = record.title;
            chapter.appendChild(title);
        }

        if (idx==0) {
            var btn = document.createElement('button');
            btn.setAttribute('id', 'clickable');
            var playpause = document.createElement('i');
            playpause.setAttribute('class','bi');
            playpause.classList.add('bi-pause-circle');  //icon default to pause because scrollama set animation default to play
            playpause.setAttribute('id', 'playpause-hist');
            playpause.setAttribute('onclick', 'pauseHistShore()');
            btn.appendChild(playpause);
            chapter.appendChild(btn);
        }

        if (record.range) {
            var label = document.createElement('label');
            label.setAttribute('for', 'customRange'+record.id);
            label.setAttribute('class', 'form-label');
            label.setAttribute('id', 'customRangeLabel'+record.id);
            label.innerText = record.range;

            var range = document.createElement('input');
            range.setAttribute('type', 'range');
            range.setAttribute('class', 'form-range');
            range.setAttribute('min', '1700');
            range.setAttribute('max', '2015');
            range.setAttribute('value', '1700')    //set the default value to 1700
            range.setAttribute('id', 'customRange'+record.id);

            chapter.appendChild(label);
            chapter.appendChild(range);
        }

        // set toggle switches for the surveyed years
        if (record.record_yrs) {
            var title = document.createElement('h5');
            title.innerText = 'Surveyed years:';
            title.style.paddingTop = '25px';
            chapter.appendChild(title);
            const row = document.createElement('div');
            row.className = 'row';
            row.setAttribute('id', 'row-switch');
            row.style.paddingTop = '5px';

            // Create two columns and append to row
            const col1 = document.createElement('div');
            col1.className = 'col';
            col1.setAttribute('id', 'col-left');
            const col2 = document.createElement('div');
            col2.className = 'col';
            col2.setAttribute('id', 'col-right');
            // row.appendChild(col1);
            // row.appendChild(col2);
            record.record_yrs.forEach((yr,idx) => {
                
                var swich = document.createElement('div');
                swich.setAttribute('class', 'form-check form-switch');
                swich.style.paddingTop = '5px';
                swich.style.paddingBottom = '5px';
                var input = document.createElement('input');
                input.setAttribute('class', 'form-check-input');
                input.setAttribute('type', 'checkbox');
                input.setAttribute('id', 'flexSwitchCheckDefault'+yr);
                swich.appendChild(input);
                var label = document.createElement('label');
                label.setAttribute('class', 'form-check-label');
                label.setAttribute('for', 'flexSwitchCheckDefault'+yr);
                label.innerText = yr.toString();
                swich.appendChild(label);

                if (idx <= record.record_yrs.length/2) {
                    //col_l = document.getElementById('col-left');
                    col1.appendChild(swich);
                } else {
                    //col_r = document.getElementById('col-right');
                    col2.appendChild(swich);
                }

            });

            row.appendChild(col1);
            row.appendChild(col2);
            chapter.appendChild(row);

        }
        
        // if lines exist
        if (record.lines) {

            // Set the dimensions and margins of the graph
            const margin = { top: 10, right: 30, bottom: 30, left: 60 },
            width = 360 - margin.left - margin.right, // Total width of the SVG
            height = 300 - margin.top - margin.bottom; // Total height of the SVG

            d3_slr = document.createElement('div');
            // set the id of this div
            d3_slr.setAttribute('id', 'd3_slr');
            
            // set the xscale
            var xScale = d3.scaleLinear()
                .domain([2020, 2150])    // the range of the projection years
                .range([0, width - margin.right]);

            // set the yscale
            var yScale = d3.scaleLinear()
                .domain([-2, 10])  // the range of the sea level rise in feet
                .range([height, 0]);

            // line generator
            const lineGenerator = d3.line()
                .x(d => xScale(d.year)) // Access the 'year' property
                .y(d => yScale(d.ft));  // Access the 'ft' property


            //confidence interval area generator
            const areaGenerator = d3.area()
                .x(d => xScale(d.year))
                .y0(d => yScale(d.lower))
                .y1(d => yScale(d.upper));

            


            // append svg to the div
            const svg = d3.select(d3_slr).append('svg')
                .attr('width', width+margin.left+margin.right)
                .attr('height', height+margin.top+margin.bottom)
                .append('g')
                .attr('transform', `translate(${margin.left}, ${margin.top})`);

            // Create the x-axis using the xScale
            const xAxis = d3.axisBottom(xScale)
                .ticks(5); // Adjust the number of ticks as needed

            // Append the x-axis to the SVG
            svg.append('g')
                .attr('class', 'x-axis')
                .attr('transform', `translate(0,${height})`) // Move the x-axis to the bottom
                .call(xAxis);

            // Create the y-axis using the yScale
            const yAxis = d3.axisLeft(yScale)
                .ticks(10);

            // Append the y-axis to the SVG
            svg.append('g')
                .attr('class', 'y-axis')
                .attr('transform', `translate(${-5},0)`) // Move the y-axis 5 pixels to the left
                .call(yAxis);

            // Add x-axis label
            svg.append('text')
                .attr('class', 'x-axis-label')
                .attr('text-anchor', 'middle')
                .attr('x', width / 2)
                .attr('y', height + margin.bottom - 5)
                .text('Year');

            // Add y-axis label
            svg.append('text')
                .attr('class', 'y-axis-label')
                .attr('text-anchor', 'middle')
                .attr('transform', `rotate(-90)`)
                .attr('x', -height / 2)
                .attr('y', -margin.left + 20)
                .text('Sea Level Rise (ft)');

            // Bind data to the SVG and create one 'path' per data series for central estimate
            svg.selectAll('.line')
            .data(record.lines) // Bind the data to the lines
            .enter() // Enter the data
            .append('path') // Append a path element for each data series
                .attr('class', 'line')
                .attr('d', d => lineGenerator(d.values)) // Generate the line
                .attr('stroke', d => d.color) // Use the color from the data
                .attr('fill', 'none')
                .attr('stroke-width', 2);


            // Bind data to the SVG and create one 'path' per data series for the confidence interval
            svg.selectAll('.confidence-interval')
            .data(record.lines) // Bind the data to the lines
            .enter() // Enter the data
            .append('path') // Append a path element for each data series
                .attr('class', 'confidence-interval')
                .attr('d', d => areaGenerator(d.values)) // Generate the line
                .attr('stroke', d => d.color) // Use the color from the data
                .attr('fill', d => d.color)
                .attr('fill-opacity', 0.2)
                .attr('stroke-dasharray', '5,5');


            chapter.appendChild(d3_slr);

        }

        if (record.image) {
            var image = new Image();
            image.src = record.image;
            chapter.appendChild(image);
        }
    
        if (record.description) {
            var story = document.createElement('p');
            story.innerHTML = record.description;
            chapter.appendChild(story);
        }
    
        container.setAttribute('id', record.id);
        container.classList.add('step');
        if (idx === 0) {
            container.classList.add('active');
        }
    
        chapter.classList.add(config.theme);
        container.appendChild(chapter);
        container.classList.add(alignments[record.alignment] || 'centered');
        if (record.hidden) {
            container.classList.add('hidden');
        }
        features.appendChild(container);
    });
    
    story.appendChild(features);
    
    var footer = document.createElement('div');
    
    if (config.footer) {
        var footerText = document.createElement('p');
        footerText.innerHTML = config.footer;
        footer.appendChild(footerText);
    }
    
    if (footer.innerText.length > 0) {
        footer.classList.add(config.theme);
        footer.setAttribute('id', 'footer');
        story.appendChild(footer);
    }
    
    mapboxgl.accessToken = config.accessToken;
    
    const transformRequest = (url) => {
        const hasQuery = url.indexOf("?") !== -1;
        const suffix = hasQuery ? "&pluginName=scrollytellingV2" : "?pluginName=scrollytellingV2";
    
        return {
          url: url + suffix
        }
    }
    
    var map = new mapboxgl.Map({
        container: 'map',
        style: config.style,
        center: config.chapters[0].location.center,
        zoom: config.chapters[0].location.zoom,
        bearing: config.chapters[0].location.bearing,
        pitch: config.chapters[0].location.pitch,
        interactive: true,
        transformRequest: transformRequest
    });
    
    if (config.showMarkers) {
        var marker = new mapboxgl.Marker({ color: config.markerColor });
        marker.setLngLat(config.chapters[0].location.center).addTo(map);
    }
    
    // instantiate the scrollama
    var scroller = scrollama();
    
    map.on("load", function() {
        if (config.use3dTerrain) {
            map.addSource('mapbox-dem', {
                'type': 'raster-dem',
                'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
                'tileSize': 512,
                'maxzoom': 14
            });
            // add the DEM source as a terrain layer with exaggerated height
            map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
    
            // add a sky layer that will show when the map is highly pitched
            map.addLayer({
                'id': 'sky',
                'type': 'sky',
                'paint': {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 15
                }
            });
        };

        var surveyed_year = [1700, 1860, 1911, 1926, 1942, 1954, 1967, 1974, 1986, 1995, 1997, 1999, 2001, 2006, 2015];

        // add sources and layers of the shorelines from 1700 to 2015
        // set them to invisible by default
        for (let i=1700; i<2015; i++) {
            // add the source for the main boundary
            map.addSource("shoreline"+i,{
                "type": "geojson",
                "data": "assets/ECY_estimated_shorelines/Oct1/"+i+".geojson"
            });

            map.addLayer({
            "id":"main-line"+i,
            "type":"line",
            "source":"shoreline"+i,
            "layout":{
                'visibility': 'none'
            },
            "paint":{
                "line-width": 1,
                "line-color": "red"
            }
        });
        // if the year is not surveyed, then do the following, otherwise, skip
        if (!surveyed_year.includes(i)) {
            // first layer of the blurred boundary
            map.addLayer({
            "id":"blur-line"+i,
            "type":"line",
            "source":"shoreline"+i,
            "layout":{
                'visibility': 'none'
            },
            "paint":{
                "line-width": 4,
                "line-color": "red",
                "line-opacity": 0.6
            }
            });

            // second layer of the blurred boundary
            map.addLayer({
            "id":"blur-line-2"+i,
            "type":"line",
            "source":"shoreline"+i,
            "layout":{
                'visibility': 'none'
            },
            "paint":{
                "line-width": 8,
                "line-color": "red",
                "line-opacity": 0.5
            }
            });

            // third layer of the blurred boundary
            map.addLayer({
            "id":"blur-line-3"+i,
            "type":"line",
            "source":"shoreline"+i,
            "layout":{
                'visibility': 'none'
            },
            "paint":{
                "line-width": 12,
                "line-color": "red",
                "line-opacity": 0.25
            }
            });
        }
        };

        // set the switches
        surveyed_year.forEach((yr) => {
            document.getElementById('flexSwitchCheckDefault'+yr).addEventListener('change', function(e) {
                if (e.target.checked) {
                    map.setLayoutProperty('main-line'+yr, 'visibility', 'visible');
                } else {
                    map.setLayoutProperty('main-line'+yr, 'visibility', 'none');
                }
            });

        });

        //let current=0;

        // function playHistShore () {
        //     myInt = setInterval(() => {
        //         if (current==0) {
        //             previous = all_years_hist_shore.length-1;
        //         };

        //         map.setLayoutProperty("main-line"+all_years_hist_shore[previous], 'visibility', 'none');
        //         map.setLayoutProperty("main-line"+all_years_hist_shore[current], 'visibility', 'visible');

        //         if (!surveyed_year.includes(all_years_hist_shore[current])) {
        //             map.setLayoutProperty("blur-line"+all_years_hist_shore[current], 'visibility', 'visible');
        //             map.setLayoutProperty("blur-line-2"+all_years_hist_shore[current], 'visibility', 'visible');
        //             map.setLayoutProperty("blur-line-3"+all_years_hist_shore[current], 'visibility', 'visible');
        //         };

        //         if (!surveyed_year.includes(all_years_hist_shore[previous])) {
        //             map.setLayoutProperty("blur-line"+all_years_hist_shore[previous], 'visibility', 'none');
        //             map.setLayoutProperty("blur-line-2"+all_years_hist_shore[previous], 'visibility', 'none');
        //             map.setLayoutProperty("blur-line-3"+all_years_hist_shore[previous], 'visibility', 'none');
        //         };

        //         document.getElementById("customRangeLabelshore-change").textContent = all_years_hist_shore[current].toString();

        //         document.getElementById("customRangeshore-change").value = all_years_hist_shore[current].toString();

        //         document.getElementById('playpause-hist').classList.remove('bi-play-circle');

        //         document.getElementById('playpause-hist').classList.add('bi-pause-circle');

        //         previous = current;
        //         current = current+1;

        //         if (current==all_years_hist_shore.length) {
        //             current=0;
        //         };

        //         //check whether the switch is on, if it is on, do not set to invisible
        //         surveyed_year.forEach((yr) => {
        //             if (document.getElementById('flexSwitchCheckDefault'+yr).checked) {
        //                 map.setLayoutProperty('main-line'+yr, 'visibility', 'visible');
        //             } 
        //         });

        //     }, 250)

            
        // };

        let previous = all_years_hist_shore.length - 1;
        let current = 0;
        let requestId;

        // Set the fps limit
        const fps = 10; // For example, 10 frames per second
        // Calculate the interval in milliseconds for each frame
        const fpsInterval = 1000 / fps;
        // Initialize the then variable with the current time
        let then = Date.now();

        function playHistShore() {
            

            function animate() {

                // Request another frame
                requestId = requestAnimationFrame(animate);

                // Get the current time
                const now = Date.now();
                // Calculate the elapsed time since the last frame
                const elapsed = now - then;

                // If enough time has elapsed, draw the next frame
                if (elapsed > fpsInterval) {
                    // Set the then variable to the current time for the next frame
                    then = now - (elapsed % fpsInterval);

                    if (current == 0) {
                    previous = all_years_hist_shore.length - 1;
                    }

                    
                    map.setLayoutProperty("main-line" + all_years_hist_shore[current], 'visibility', 'visible');

                    map.setLayoutProperty("main-line" + all_years_hist_shore[previous], 'visibility', 'none');

                    //if the current year is not a surveyed year, then show the blurred layers
                    if (!surveyed_year.includes(all_years_hist_shore[current])) {
                    map.setLayoutProperty("blur-line" + all_years_hist_shore[current], 'visibility', 'visible');
                    map.setLayoutProperty("blur-line-2" + all_years_hist_shore[current], 'visibility', 'visible');
                    map.setLayoutProperty("blur-line-3" + all_years_hist_shore[current], 'visibility', 'visible');
                    }

                    // if the previous year is not a surveyed year, then hide the blurred layers
                    if (!surveyed_year.includes(all_years_hist_shore[previous])) {
                    map.setLayoutProperty("blur-line" + all_years_hist_shore[previous], 'visibility', 'none');
                    map.setLayoutProperty("blur-line-2" + all_years_hist_shore[previous], 'visibility', 'none');
                    map.setLayoutProperty("blur-line-3" + all_years_hist_shore[previous], 'visibility', 'none');
                    }

                    document.getElementById("customRangeLabelshore-change").textContent = all_years_hist_shore[current].toString();
                    document.getElementById("customRangeshore-change").value = all_years_hist_shore[current].toString();
                    document.getElementById('playpause-hist').classList.remove('bi-play-circle');
                    document.getElementById('playpause-hist').classList.add('bi-pause-circle');

                    previous = current;
                    current = current + 1;

                    if (current == all_years_hist_shore.length) {
                        current = 0;
                    }

                    //check whether the switch is on, if it is on, do not set to invisible
                    surveyed_year.forEach((yr) => {
                    if (document.getElementById('flexSwitchCheckDefault' + yr).checked) {
                        map.setLayoutProperty('main-line' + yr, 'visibility', 'visible');
                    }
                    });


                }
                

                // setTimeout(() => {
                //     requestId=requestAnimationFrame(animate);
                //     }, 250);
            }
            requestId=requestAnimationFrame(animate);
            //animate();
        };


        function pauseHistShore () {
            cancelAnimationFrame(requestId);

            document.getElementById('playpause-hist').classList.remove('bi-pause-circle');
            document.getElementById('playpause-hist').classList.add('bi-play-circle');
        };

        // Get the range slider element by its ID
        const rangeSlider = document.getElementById('customRangeshore-change');

        // Listen for the 'input' event
        rangeSlider.addEventListener('input', function(event) {

            pauseHistShore();
            // Get the current value
            const currentValue = event.target.value;

            current = all_years_hist_shore.indexOf(parseInt(currentValue));

            

            document.getElementById("customRangeLabelshore-change").textContent = currentValue;

            // Hide all layers
            setAllHistLayersInvisible();

            //show layers that are toggled on by the switch
            surveyed_year.forEach((yr) => {
                if (document.getElementById('flexSwitchCheckDefault'+yr).checked) {
                    map.setLayoutProperty('main-line'+yr, 'visibility', 'visible');
                } 
            });

            // Show the layer for the current year
            map.setLayoutProperty("main-line"+currentValue, 'visibility', 'visible');

            // if the current year is not a surveyed year, then show the blurred layers
            if (!surveyed_year.includes(parseInt(currentValue))) {
                map.setLayoutProperty("blur-line"+currentValue, 'visibility', 'visible');
                map.setLayoutProperty("blur-line-2"+currentValue, 'visibility', 'visible');
                map.setLayoutProperty("blur-line-3"+currentValue, 'visibility', 'visible');



            }
        });

        // set the function to play animation of historical shorelines

        

        //document.addEventListener('DOMContentLoaded', () => {
        playPauseButton = document.getElementById('clickable');
        playPauseIcon = playPauseButton.querySelector('i');

        playPauseButton.addEventListener('click', () => {
            
            if (playPauseIcon.classList.contains('bi-play-circle')) {
                playPauseIcon.classList.remove('bi-play-circle');
                playPauseIcon.classList.add('bi-pause-circle');
                playHistShore();
            } else {
                playPauseIcon.classList.remove('bi-pause-circle');
                playPauseIcon.classList.add('bi-play-circle');
                pauseHistShore();
            }
        });



        //});

        
    
        // setup the instance, pass callback functions
        scroller
        .setup({
            
            step: '.step',
            offset: 0.5,
            progress: true,
            //debug: true
        })
        .onStepEnter(response => {
            var chapter = config.chapters.find(chap => chap.id === response.element.id);

            if (response.element.id=="shore-change") {
                console.log("hello");
                current=0;
                playHistShore();
            };

            response.element.classList.add('active');
            

            map[chapter.mapAnimation || 'flyTo'](chapter.location);
    
            if (config.showMarkers) {
                marker.setLngLat(chapter.location.center);
            }
            // if (chapter.onChapterEnter.length > 0) {
            //     chapter.onChapterEnter.forEach(setLayerOpacity);
            // }
            if (chapter.callback) {
                window[chapter.callback]();
            }
            if (chapter.rotateAnimation) {
                map.once('moveend', function() {
                    const rotateNumber = map.getBearing();
                    map.rotateTo(rotateNumber + 90, {
                        duration: 24000, easing: function (t) {
                            return t;
                        }
                    });
                });
            }
            //if (chapter.id=="shore-change") {
                
                
            //}
        })
        .onStepExit(response => {
            var chapter = config.chapters.find(chap => chap.id === response.element.id);
            response.element.classList.remove('active');
            // if (chapter.onChapterExit.length > 0) {
            //     chapter.onChapterExit.forEach(setLayerOpacity);
            // }

            if (chapter.id == "shore-change") {
                pauseHistShore();
                setAllHistLayersInvisible();
                
            }
        });
    });
    
    // setup resize event
    window.addEventListener('resize', scroller.resize);

    
    
    </script>

    <script>
        function scrollToMapbox() {
        // This will smoothly scroll the page to the Mapbox container
        document.getElementById('geonarrative-container').scrollIntoView({ behavior: 'smooth' });
        }
    </script>
 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  </body>
</html>